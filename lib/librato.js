// Generated by CoffeeScript 1.6.3
(function() {
  var Client, Collector, EventEmitter, Worker, client, collector, config, librato, middleware, worker, _ref;

  EventEmitter = require('events').EventEmitter;

  Client = require('./client');

  Worker = require('./worker');

  Collector = require('./collector');

  middleware = require('./middleware');

  _ref = {}, collector = _ref.collector, client = _ref.client, worker = _ref.worker, config = _ref.config;

  librato = new EventEmitter();

  librato.configure = function(newConfig) {
    config = newConfig;
    collector = new Collector();
    client = new Client(config);
    return worker = new Worker({
      job: librato.flush
    });
  };

  librato.increment = function(name) {
    return collector.increment(name);
  };

  librato.timing = function(name, valueMs) {
    return collector.timing(name, valueMs);
  };

  librato.annotation = function(stream, title, options) {
    if (options == null) {
      options = {};
    }
    return collector.annotate(stream, title, options);
  };

  librato.start = function() {
    return worker.start();
  };

  librato.stop = function() {
    worker.stop();
    return librato.flush();
  };

  librato.flush = function() {
    var a, annotations, gauges, measurement, v, _i, _j, _len, _len1, _results;
    gauges = [];
    collector.flushTo(gauges);
    for (_i = 0, _len = gauges.length; _i < _len; _i++) {
      measurement = gauges[_i];
      measurement.source = config.source;
    }
    if (gauges.length) {
      client.send({
        gauges: gauges
      }, function(err) {
        if (err != null) {
          return librato.emit('error', err);
        }
      });
    }
    annotations = [];
    collector.flushToAnnotation(annotations);
    if (annotations.length) {
      _results = [];
      for (_j = 0, _len1 = annotations.length; _j < _len1; _j++) {
        a = annotations[_j];
        _results.push((function() {
          var _k, _len2, _ref1, _results1;
          _ref1 = a.value;
          _results1 = [];
          for (_k = 0, _len2 = _ref1.length; _k < _len2; _k++) {
            v = _ref1[_k];
            _results1.push(client.send({
              annotation: true,
              name: a.name,
              body: v
            }, function(err) {
              if (err != null) {
                return librato.emit('error', err);
              }
            }));
          }
          return _results1;
        })());
      }
      return _results;
    }
  };

  librato.middleware = middleware(librato);

  module.exports = librato;

}).call(this);
